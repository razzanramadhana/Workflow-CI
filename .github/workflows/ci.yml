name: CI Retrain (MLflow Project)

on:
  push:
    paths:
      - "MLProject/**"
  workflow_dispatch:

jobs:
  retrain:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install MLflow + deps
        run: |
          python -m pip install --upgrade pip
          pip install mlflow pandas numpy scikit-learn matplotlib joblib

      - name: Run MLflow Project (retrain)
        working-directory: MLProject
        run: |
          mlflow run . --env-manager=local -e main \
            -P data_path="namadataset_preprocessing/loan_processed.csv" \
            -P experiment_name="CI_Retrain_Loan" \
            -P output_dir="outputs"

      # âœ… Skilled: simpan artifacts ke repository (commit + push)
      - name: Commit artifacts to repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          mkdir -p artifacts/latest

          # salin output training terbaru (abaikan kalau kosong)
          cp -r MLProject/outputs/* artifacts/latest/ 2>/dev/null || true

          # (opsional) simpan juga tracking folder mlruns
          mkdir -p artifacts/mlruns
          cp -r MLProject/mlruns artifacts/mlruns/ 2>/dev/null || true

          git add artifacts/latest artifacts/mlruns
          git commit -m "CI: update retrain artifacts" || echo "No changes to commit"
          git push

      # (opsional) tetap upload ke GitHub Actions artifact juga
      - name: Upload outputs artifact (Skilled minimal)
        uses: actions/upload-artifact@v4
        with:
          name: retrain-outputs
          path: |
            MLProject/outputs
            MLProject/mlruns
            artifacts/latest
            artifacts/mlruns
